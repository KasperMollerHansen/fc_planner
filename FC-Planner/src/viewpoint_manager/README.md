# ‚öΩ FC-Planner

## *Viewpoint Manager package*

‚úçÔ∏è Author: [Chen Feng](https://chen-albert-feng.github.io/AlbertFeng.github.io/) and Mingjie Zhang

### üìñ Usage

Here we provide an independent package of finding the minimal viewpoint set for a given area needed to cover, *i.e.*, our proposed ***Iterative Updates of Viewpoint Pose***.

Specifically, we give a 3D case guided by skeleton. Run ```Rviz``` for visualization and open another terminal for viewpoint generation execution:
```shell
sudo cpufreq-set -g performance
source devel/setup.zsh && roslaunch viewpoint_manager rviz.launch
source devel/setup.zsh && roslaunch viewpoint_manager mbs.launch
```

Afterwards, you will see the viewpoint generation results of Marina Bay Sands in your ```Rviz``` as follows:
<p align="center">
  <img src="../../../misc/iterative_updates.png" width = 80% height = 60%/>
</p>

Moreover, we provide a simple case of indoor office scene using normal guidance to generate initial viewpoints and then update them. Run ```Rviz``` for visualization and open another terminal for viewpoint generation execution:
```shell
sudo cpufreq-set -g performance
source devel/setup.zsh && roslaunch viewpoint_manager rviz_normal.launch
source devel/setup.zsh && roslaunch viewpoint_manager normal.launch
```

Afterwards, you will see the viewpoint generation results of this 2.5D case in your ```Rviz``` as follows:
<p align="center">
  <img src="../../../misc/2.5D_case.png" width = 80% height = 60%/>
</p>

Additionally, we also give the illustration of each function in this package for your convenience, as follows:

- **Reset State** - `reset()`: Resets the state of the system to its default values. 
- **Set Map Point Cloud** - `setMapPointCloud()`: Input the point cloud $PT_{map}$ used to build the map.
- **Set Model Point Cloud** - `setModel()`: Input the point cloud $PT_{model}$ to be covered, typically a downsampled map point cloud.
- **Set Model Normals** - `setNormals()`: Input the **outward-facing** normals $N_{model}$ for $PT_{model}$.
- **Set Initial Viewpoints (Optional)** - `setInitViewpoints()`: Input the initial viewpoints. (If you don't input initial viewpoints, the viewpoints will be generated by $N_{model}$).
- **Main Update Function** - `updateViewpoints()`: The primary API call to update the viewpoints according to the provided data. 
- **Retrieve Updated Viewpoints** - `getUpdatedViewpoints()`: Fetches the final set of updated viewpoints after the `updateViewpoints()` function has been called.

For an example of integrating this package, you can refer to its usage within the FC-Planner code. This serves as a practical reference for how to apply the package in a larger project.
```C++
    viewpoint_manager_->reset();
    viewpoint_manager_->setMapPointCloud(PR.occ_model);
    viewpoint_manager_->setModel(PR.model);
    viewpoint_manager_->setNormals(PR.pt_normal_pairs);
    viewpoint_manager_->setInitViewpoints(all_safe_normal_vps);
    viewpoint_manager_->updateViewpoints();
    viewpoint_manager_->getUpdatedViewpoints(updated_vps);
    viewpoint_manager_->getUncoveredModelCloud(uncovered_area);
```
### ‚öôÔ∏è Parameter
For your customized scene, you can create the corresponding `.launch` file using the template provided in the example scenes located in `src/rosa/launch`. Below is the meaning of each hyperparameter for your adjustment: 
```
viewpoint_manager/visible_range         : [double] --> The visible range for viewpoints.
viewpoint_manager/viewpoints_distance   : [double] --> The distance between viewpoints.
viewpoint_manager/fov_h                 : [double] --> The horizontal field of view angle for the viewpoints.
viewpoint_manager/fov_w                 : [double] --> The vertical field of view angle for the viewpoints.
viewpoint_manager/pitch_upper           : [double] --> The upper limit for the pitch angle of viewpoints.
viewpoint_manager/pitch_lower           : [double] --> The lower limit for the pitch angle of viewpoints.
viewpoint_manager/zGround               : [bool] --> A flag indicating whether to use the ground Z position.
viewpoint_manager/GroundPos             : [double] --> The Z position of the ground plane.
viewpoint_manager/safeHeight            : [double] --> The safe height for viewpoints above the ground.
viewpoint_manager/safe_radius           : [double] --> The safe radius for viewpoints.
viewpoint_manager/attitude_type         : [string] --> The type of attitude for viewpoints.
viewpoint_manager/max_iter_num          : [int] --> The maximum number of iterations for viewpoint optimization.
viewpoint_manager/pose_update           : [bool] --> A flag indicating whether the viewpoint pose is updated according to the visible voxels.
```
**Important notice**: this package only supports ***surface point cloud***, which means interior should be clear.
